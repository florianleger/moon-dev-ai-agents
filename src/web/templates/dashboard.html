{% extends "base.html" %}

{% block title %}Dashboard - Moon Dev Trading{% endblock %}

{% block content %}
<div x-data="dashboardData()" x-init="init()">
    <!-- Header with actions -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">Trading Dashboard</h1>
        <div class="flex gap-2">
            <button @click="toggleStrategy()"
                    :class="running ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'"
                    class="px-4 py-2 rounded-lg text-white font-medium transition-colors">
                <span x-text="running ? 'Stop Strategy' : 'Start Strategy'"></span>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- Balance -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Paper Balance</p>
                    <p class="text-2xl font-bold text-white" x-text="'$' + balance.toFixed(2)">$0.00</p>
                </div>
                <div class="text-3xl">&#128176;</div>
            </div>
        </div>

        <!-- Daily PnL -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Daily PnL</p>
                    <p class="text-2xl font-bold"
                       :class="dailyPnl >= 0 ? 'text-green-400' : 'text-red-400'"
                       x-text="(dailyPnl >= 0 ? '+$' : '-$') + Math.abs(dailyPnl).toFixed(2)">$0.00</p>
                </div>
                <div class="text-3xl" x-text="dailyPnl >= 0 ? '&#128200;' : '&#128201;'">&#128200;</div>
            </div>
        </div>

        <!-- Margin Used -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Margin Used</p>
                    <p class="text-2xl font-bold"
                       :class="usedMargin > balance * 0.8 ? 'text-red-400' : 'text-white'"
                       x-text="'$' + usedMargin.toFixed(2)">$0.00</p>
                    <p class="text-xs text-gray-500" x-text="openPositions + ' positions'"></p>
                </div>
                <div class="text-3xl">&#128202;</div>
            </div>
        </div>

        <!-- Total PnL -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Total PnL</p>
                    <p class="text-2xl font-bold"
                       :class="totalPnl >= 0 ? 'text-green-400' : 'text-red-400'"
                       x-text="(totalPnl >= 0 ? '+$' : '-$') + Math.abs(totalPnl).toFixed(2)">$0.00</p>
                </div>
                <div class="text-3xl">&#127775;</div>
            </div>
        </div>
    </div>

    <!-- PnL Chart -->
    <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 mb-6">
        <h2 class="text-lg font-semibold text-white mb-4">PnL History (7 Days)</h2>
        <div class="h-64">
            <canvas id="pnlChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Open Positions Table -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-white">Open Positions</h2>
                <button @click="closeAllPositions()"
                        x-show="positions.length > 0"
                        class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white transition-colors">
                    Close All
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="text-left py-2">Symbol</th>
                            <th class="text-left py-2">Side</th>
                            <th class="text-right py-2">Size</th>
                            <th class="text-right py-2">Entry</th>
                            <th class="text-right py-2">PnL</th>
                            <th class="text-right py-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="pos in positions" :key="pos._uid || pos.position_id || pos.symbol">
                            <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                                <td class="py-3 font-medium text-white" x-text="pos.symbol"></td>
                                <td class="py-3">
                                    <span :class="pos.side === 'LONG' ? 'text-green-400' : 'text-red-400'"
                                          x-text="pos.side"></span>
                                </td>
                                <td class="py-3 text-right text-gray-300" x-text="'$' + pos.size_usd.toFixed(2)"></td>
                                <td class="py-3 text-right text-gray-300" x-text="'$' + pos.entry_price.toFixed(2)"></td>
                                <td class="py-3 text-right"
                                    :class="pos.unrealized_pnl >= 0 ? 'text-green-400' : 'text-red-400'"
                                    x-text="(pos.unrealized_pnl >= 0 ? '+' : '') + '$' + pos.unrealized_pnl.toFixed(2)"></td>
                                <td class="py-3 text-right">
                                    <button @click="closePosition(pos.symbol)"
                                            class="text-red-400 hover:text-red-300 px-2 py-1 rounded border border-red-400/30 hover:border-red-400">
                                        Close
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="positions.length === 0">
                            <td colspan="6" class="py-8 text-center text-gray-500">
                                No open positions
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Signals -->
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">Recent Signals</h2>

            <div class="space-y-3 max-h-[500px] overflow-y-auto">
                <template x-for="(signal, index) in signals" :key="signal.timestamp + '-' + index">
                    <div class="bg-gray-700/30 rounded-lg overflow-hidden">
                        <!-- Signal Header (clickable) -->
                        <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-700/50 transition-colors"
                             @click="signal.expanded = !signal.expanded">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400 text-xs" x-text="formatTime(signal.timestamp)"></span>
                                <span class="font-medium text-white" x-text="signal.symbol"></span>
                                <span :class="{
                                    'bg-green-500/20 text-green-400': signal.action === 'BUY',
                                    'bg-red-500/20 text-red-400': signal.action === 'SELL',
                                    'bg-gray-500/20 text-gray-400': signal.action === 'NEUTRAL'
                                }" class="px-2 py-0.5 rounded text-xs font-medium" x-text="signal.action"></span>
                                <span x-show="signal.setup_type" class="text-purple-400 text-xs" x-text="signal.setup_type"></span>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- Weighted Score (Sniper) -->
                                <span x-show="signal.weighted_score" class="text-moon-purple font-bold text-sm"
                                      x-text="signal.weighted_score + '/10'"></span>
                                <!-- Confidence bar -->
                                <div class="flex items-center gap-2">
                                    <div class="w-16 bg-gray-600 rounded-full h-2">
                                        <div class="h-2 rounded-full"
                                             :class="signal.confidence >= 70 ? 'bg-green-500' : signal.confidence >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                                             :style="'width: ' + signal.confidence + '%'"></div>
                                    </div>
                                    <span class="text-gray-400 text-xs w-8" x-text="signal.confidence + '%'"></span>
                                </div>
                                <!-- Expand indicator -->
                                <span class="text-gray-500 text-xs" x-text="signal.expanded ? '▼' : '▶'"></span>
                            </div>
                        </div>

                        <!-- Expanded Details -->
                        <div x-show="signal.expanded"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 -translate-y-2"
                             x-transition:enter-end="opacity-100 translate-y-0"
                             class="px-3 pb-3 border-t border-gray-600/50">
                            <!-- Checklist (Sniper AI) -->
                            <div x-show="signal.checklist" class="mt-3">
                                <p class="text-gray-400 text-xs mb-2">Checklist (<span x-text="signal.checklist_score"></span>)</p>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <template x-for="(check, name) in signal.checklist" :key="name">
                                        <div class="flex items-center gap-2 p-2 rounded"
                                             :class="check.passed ? 'bg-green-500/10' : 'bg-gray-600/30'">
                                            <span :class="check.passed ? 'text-green-400' : 'text-gray-500'"
                                                  x-text="check.passed ? '✓' : '✗'"></span>
                                            <div class="flex-1">
                                                <span class="text-gray-300" x-text="formatCheckName(name)"></span>
                                                <span class="text-gray-500 ml-1" x-text="formatCheckValue(name, check)"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- AI Reasoning -->
                            <div x-show="signal.ai_reasoning" class="mt-3">
                                <p class="text-gray-400 text-xs mb-1">AI Reasoning</p>
                                <p class="text-gray-300 text-xs bg-gray-800/50 p-2 rounded" x-text="signal.ai_reasoning"></p>
                            </div>

                            <!-- Price & Status -->
                            <div class="mt-3 flex items-center gap-4 text-xs">
                                <span x-show="signal.current_price" class="text-gray-400">
                                    Price: <span class="text-white" x-text="'$' + signal.current_price?.toLocaleString()"></span>
                                </span>
                                <span :class="signal.approved ? 'text-green-400' : 'text-red-400'"
                                      x-text="signal.approved ? 'Approved' : 'Rejected'"></span>
                                <span x-show="signal.reason && !signal.approved" class="text-gray-500" x-text="signal.reason"></span>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="signals.length === 0" class="py-8 text-center text-gray-500">
                    No recent signals
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboardData() {
    return {
        running: {{ 'true' if strategy_running else 'false' }},
        balance: 500.0,
        dailyPnl: 0.0,
        totalPnl: 0.0,
        openPositions: 0,
        usedMargin: 0.0,
        positions: [],
        signals: [],
        pnlChart: null,

        init() {
            this.fetchStats();
            this.fetchPositions();
            this.fetchSignals();
            this.setupSSE();

            // Initialize chart after a short delay to ensure DOM is ready
            // This fixes a race condition where Chart.js fails to render
            setTimeout(() => this.initChart(), 100);

            // Refresh data periodically
            setInterval(() => {
                this.fetchStats();
                this.fetchPositions();
                this.fetchSignals();
            }, 10000);
        },

        async fetchStats() {
            try {
                const data = await apiFetch('/api/dashboard/stats');
                this.balance = data.balance || 500;
                this.dailyPnl = data.daily_pnl || 0;
                this.totalPnl = data.total_pnl || 0;
                this.openPositions = data.open_positions || 0;
                this.usedMargin = data.used_margin || 0;
                this.running = data.running || false;
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        },

        async fetchPositions() {
            try {
                const rawPositions = await apiFetch('/api/positions') || [];
                // Ensure each position has a unique ID
                this.positions = rawPositions.map((p, i) => ({
                    ...p,
                    _uid: p.position_id || `${p.symbol}-${i}-${p.entry_price}`
                }));
            } catch (e) {
                console.error('Failed to fetch positions:', e);
            }
        },

        async fetchSignals() {
            try {
                const data = await apiFetch('/api/strategy/signals?limit=10');
                this.signals = (data.signals || []).map(s => this.mapSignal(s));
            } catch (e) {
                console.error('Failed to fetch signals:', e);
            }
        },

        mapSignal(s) {
            return {
                timestamp: s.timestamp,
                symbol: s.token || s.symbol,
                action: s.direction || s.action,
                confidence: s.confidence || 0,
                reasoning: s.reason || s.reasoning || '',
                // Extended fields for Sniper AI
                weighted_score: s.weighted_score,
                checklist_score: s.checklist_score,
                setup_type: s.setup_type,
                ai_reasoning: s.ai_reasoning,
                checklist: s.checklist_details,
                current_price: s.current_price,
                approved: s.approved,
                reason: s.reason,
                expanded: false,  // For expandable UI
            };
        },

        formatCheckName(name) {
            const names = {
                'extreme_move': 'Extreme Move',
                'funding_divergence': 'Funding',
                'liquidation_cascade': 'Liquidations',
                'multi_tf': 'Multi-TF',
                'volume_climax': 'Volume',
                'time_window': 'Time Window',
                'ai_validation': 'AI Validation',
            };
            return names[name] || name;
        },

        formatCheckValue(name, check) {
            if (name === 'extreme_move' && check.sigma !== undefined) {
                return `(${check.sigma}σ)`;
            }
            if (name === 'funding_divergence' && check.zscore !== undefined) {
                return `(z=${check.zscore})`;
            }
            if (name === 'liquidation_cascade' && check.ratio !== undefined) {
                return `(${check.ratio}x)`;
            }
            if (name === 'multi_tf' && check.agreement !== undefined) {
                return `(${check.agreement}%)`;
            }
            if (name === 'volume_climax' && check.ratio !== undefined) {
                return `(${check.ratio}x)`;
            }
            if (name === 'time_window' && check.hour_utc !== undefined) {
                return `(${check.hour_utc}h UTC)`;
            }
            if (name === 'ai_validation' && check.confidence !== undefined) {
                return `(${check.confidence}%)`;
            }
            return '';
        },

        async initChart() {
            try {
                const data = await apiFetch('/api/dashboard/pnl?days=7');

                // Destroy existing chart if present
                if (this.pnlChart) {
                    this.pnlChart.destroy();
                    this.pnlChart = null;
                }

                const canvas = document.getElementById('pnlChart');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }

                // Clear canvas before creating new chart
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                this.pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || [],
                        datasets: [{
                            label: 'PnL',
                            data: data.data || [],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgb(34, 197, 94)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(75, 85, 99, 0.3)' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                grid: { color: 'rgba(75, 85, 99, 0.3)' },
                                ticks: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to init chart:', e);
            }
        },

        setupSSE() {
            // SSE for real-time updates (optional, fallback to polling)
            try {
                const eventSource = new EventSource('/api/dashboard/sse');

                eventSource.addEventListener('stats', (e) => {
                    const data = JSON.parse(e.data);
                    this.balance = data.balance || this.balance;
                    this.dailyPnl = data.daily_pnl || this.dailyPnl;
                    this.totalPnl = data.total_pnl || this.totalPnl;
                    this.openPositions = data.open_positions || this.openPositions;
                    this.usedMargin = data.used_margin || this.usedMargin;
                    this.running = data.running || false;
                });

                eventSource.addEventListener('positions', (e) => {
                    const rawPositions = JSON.parse(e.data) || [];
                    // Ensure each position has a unique ID
                    this.positions = rawPositions.map((p, i) => ({
                        ...p,
                        _uid: p.position_id || `${p.symbol}-${i}-${p.entry_price}`
                    }));
                });

                eventSource.addEventListener('signals', (e) => {
                    const rawSignals = JSON.parse(e.data);
                    this.signals = (rawSignals || []).map(s => this.mapSignal(s));
                });

                eventSource.onerror = () => {
                    eventSource.close();
                    // Fall back to polling only
                };
            } catch (e) {
                // SSE not supported or failed, polling will handle updates
            }
        },

        async toggleStrategy() {
            const endpoint = this.running ? '/api/strategy/stop' : '/api/strategy/start';
            try {
                const data = await apiFetch(endpoint, { method: 'POST' });
                this.running = !this.running;
                showToast(data.message, 'success');
            } catch (e) {
                showToast('Failed to toggle strategy', 'error');
            }
        },

        async closePosition(symbol) {
            if (!confirm(`Close ${symbol} position?`)) return;
            try {
                const data = await apiFetch(`/api/positions/${symbol}/close`, { method: 'POST' });
                showToast(`Closed ${symbol}: ${data.pnl >= 0 ? '+' : ''}$${data.pnl}`, 'success');
                this.fetchPositions();
                this.fetchStats();
            } catch (e) {
                showToast('Failed to close position', 'error');
            }
        },

        async closeAllPositions() {
            if (!confirm('Close ALL positions?')) return;
            try {
                const data = await apiFetch('/api/positions/close-all', { method: 'POST' });
                showToast(`Closed ${data.count} positions: ${data.total_pnl >= 0 ? '+' : ''}$${data.total_pnl}`, 'success');
                this.fetchPositions();
                this.fetchStats();
            } catch (e) {
                showToast('Failed to close positions', 'error');
            }
        },

        formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
    };
}
</script>
{% endblock %}
