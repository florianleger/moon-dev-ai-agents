{% extends "base.html" %}

{% block title %}Settings - Moon Dev Trading{% endblock %}

{% block content %}
<div x-data="settingsData()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">Settings</h1>
        <button @click="saveSettings()"
                :disabled="saving"
                class="bg-moon-purple hover:bg-purple-700 disabled:bg-gray-600 px-6 py-2 rounded-lg text-white font-medium transition-colors flex items-center gap-2">
            <span x-show="saving" class="animate-spin">&#8634;</span>
            <span x-text="saving ? 'Saving...' : 'Save Changes'"></span>
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Trading Mode -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">Trading Mode</h2>

            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-gray-700/30 rounded-lg">
                    <div>
                        <p class="text-white font-medium">Paper Trading</p>
                        <p class="text-gray-400 text-sm">Simulate trades without real execution</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="settings.paper_trading" class="sr-only peer">
                        <div class="w-14 h-7 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg"
                     x-show="!settings.paper_trading">
                    <p class="text-yellow-400 text-sm flex items-center gap-2">
                        <span>&#9888;</span>
                        <span>Live trading enabled - real money at risk!</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- RAMF Parameters -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">RAMF Strategy Parameters</h2>

            <div class="space-y-4">
                <!-- Leverage -->
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Leverage (1-10)</label>
                    <div class="flex items-center gap-4">
                        <input type="range" x-model="settings.leverage" min="1" max="10" step="1"
                               class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <span class="text-white font-medium w-8 text-center" x-text="settings.leverage + 'x'"></span>
                    </div>
                </div>

                <!-- Min Confidence -->
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Min Confidence (%)</label>
                    <div class="flex items-center gap-4">
                        <input type="range" x-model="settings.min_confidence" min="0" max="100" step="5"
                               class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <span class="text-white font-medium w-12 text-center" x-text="settings.min_confidence + '%'"></span>
                    </div>
                </div>

                <!-- Max Daily Trades -->
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Max Daily Trades</label>
                    <input type="number" x-model="settings.max_daily_trades" min="1" max="50"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-moon-purple focus:outline-none">
                </div>
            </div>
        </div>

        <!-- Assets -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">Trading Assets</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Assets (comma-separated)</label>
                    <input type="text" x-model="assetsInput"
                           placeholder="BTC, ETH, SOL"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-moon-purple focus:outline-none">
                </div>

                <div class="flex flex-wrap gap-2">
                    <template x-for="asset in settings.assets" :key="asset">
                        <span class="bg-moon-purple/20 text-purple-300 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                            <span x-text="asset"></span>
                            <button @click="removeAsset(asset)" class="hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
            </div>
        </div>

        <!-- Features Toggle -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">RAMF Features</h2>

            <div class="space-y-3">
                <template x-for="(enabled, feature) in settings.features" :key="feature">
                    <div class="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg">
                        <span class="text-white" x-text="formatFeatureName(feature)"></span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="settings.features[feature]" class="sr-only peer" disabled>
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                </template>
                <p class="text-gray-500 text-xs mt-2">Feature toggles require config.py edit (read-only here)</p>
            </div>
        </div>
    </div>

    <!-- Risk Management (read-only info) -->
    <div class="mt-6 bg-gray-800 rounded-xl p-6 border border-gray-700">
        <h2 class="text-lg font-semibold text-white mb-4">Risk Management (from config.py)</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-4 bg-gray-700/30 rounded-lg">
                <p class="text-gray-400 text-sm">Stop Loss</p>
                <p class="text-white font-medium" x-text="settings.stop_loss_pct + '%'">-</p>
            </div>
            <div class="p-4 bg-gray-700/30 rounded-lg">
                <p class="text-gray-400 text-sm">Take Profit</p>
                <p class="text-white font-medium" x-text="settings.take_profit_pct + '%'">-</p>
            </div>
            <div class="p-4 bg-gray-700/30 rounded-lg">
                <p class="text-gray-400 text-sm">Max Daily Loss</p>
                <p class="text-white font-medium">$25</p>
            </div>
            <div class="p-4 bg-gray-700/30 rounded-lg">
                <p class="text-gray-400 text-sm">Max Daily Gain</p>
                <p class="text-white font-medium">$25</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsData() {
    return {
        settings: {
            paper_trading: true,
            leverage: 3,
            min_confidence: 70,
            max_daily_trades: 6,
            assets: ['BTC', 'ETH', 'SOL'],
            stop_loss_pct: 1.0,
            take_profit_pct: 2.0,
            features: {
                adaptive_sl_tp: true,
                time_windows: true,
                mtf_confluence: true,
                funding_divergence: true,
                liquidation_clusters: true,
            }
        },
        assetsInput: '',
        saving: false,

        init() {
            this.fetchSettings();
        },

        async fetchSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                this.settings = {
                    ...this.settings,
                    ...data,
                };
                this.assetsInput = data.assets?.join(', ') || '';
            } catch (e) {
                console.error('Failed to fetch settings:', e);
            }
        },

        async saveSettings() {
            this.saving = true;

            // Parse assets from input
            const assetsArray = this.assetsInput
                .split(',')
                .map(a => a.trim().toUpperCase())
                .filter(a => a);

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paper_trading: this.settings.paper_trading,
                        leverage: parseInt(this.settings.leverage),
                        min_confidence: parseInt(this.settings.min_confidence),
                        max_daily_trades: parseInt(this.settings.max_daily_trades),
                        assets: assetsArray.join(','),
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast('Settings saved! Restart strategy for changes to take effect.', 'success');
                    this.settings.assets = assetsArray;
                } else {
                    showToast(data.detail || 'Failed to save settings', 'error');
                }
            } catch (e) {
                showToast('Failed to save settings', 'error');
            } finally {
                this.saving = false;
            }
        },

        removeAsset(asset) {
            this.settings.assets = this.settings.assets.filter(a => a !== asset);
            this.assetsInput = this.settings.assets.join(', ');
        },

        formatFeatureName(feature) {
            return feature
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }
    };
}
</script>
{% endblock %}
