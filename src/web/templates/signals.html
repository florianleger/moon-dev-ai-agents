{% extends "base.html" %}

{% block title %}Signals - Moon Dev Trading{% endblock %}

{% block content %}
<div x-data="signalsData()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">Signal History</h1>
        <div class="flex items-center gap-4">
            <select x-model="filter"
                    class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-moon-purple focus:outline-none">
                <option value="all">All Signals</option>
                <option value="BUY">Buy Only</option>
                <option value="SELL">Sell Only</option>
                <option value="NEUTRAL">Neutral Only</option>
            </select>
            <button @click="fetchSignals()"
                    class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-white transition-colors">
                &#8635; Refresh
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Total Signals</p>
            <p class="text-2xl font-bold text-white" x-text="signals.length">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Buy Signals</p>
            <p class="text-2xl font-bold text-green-400" x-text="signals.filter(s => s.action === 'BUY').length">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Sell Signals</p>
            <p class="text-2xl font-bold text-red-400" x-text="signals.filter(s => s.action === 'SELL').length">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Avg Confidence</p>
            <p class="text-2xl font-bold text-yellow-400" x-text="avgConfidence + '%'">0%</p>
        </div>
    </div>

    <!-- Signals List -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
        <div class="p-4 bg-gray-700/30 border-b border-gray-700">
            <div class="grid grid-cols-12 gap-4 text-gray-400 text-sm font-medium">
                <div class="col-span-2">Time</div>
                <div class="col-span-2">Symbol</div>
                <div class="col-span-2">Signal</div>
                <div class="col-span-2">Score</div>
                <div class="col-span-2">Confidence</div>
                <div class="col-span-2">Status</div>
            </div>
        </div>

        <div class="divide-y divide-gray-700/50">
            <template x-for="signal in filteredSignals" :key="signal.timestamp + signal.symbol">
                <div class="bg-gray-800 hover:bg-gray-700/30 transition-colors">
                    <!-- Signal Row (clickable) -->
                    <div class="p-4 cursor-pointer" @click="signal.expanded = !signal.expanded">
                        <div class="grid grid-cols-12 gap-4 items-center">
                            <div class="col-span-2 text-gray-400 text-sm" x-text="formatDateTime(signal.timestamp)"></div>
                            <div class="col-span-2">
                                <span class="font-medium text-white" x-text="signal.symbol"></span>
                                <span x-show="signal.setup_type" class="ml-2 text-purple-400 text-xs" x-text="signal.setup_type"></span>
                            </div>
                            <div class="col-span-2">
                                <span :class="{
                                    'bg-green-500/20 text-green-400 border-green-500/30': signal.action === 'BUY',
                                    'bg-red-500/20 text-red-400 border-red-500/30': signal.action === 'SELL',
                                    'bg-gray-500/20 text-gray-400 border-gray-500/30': signal.action === 'NEUTRAL'
                                }" class="px-3 py-1 rounded-full text-xs font-medium border" x-text="signal.action"></span>
                            </div>
                            <div class="col-span-2">
                                <span x-show="signal.weighted_score" class="text-moon-purple font-bold" x-text="signal.weighted_score + '/10'"></span>
                                <span x-show="!signal.weighted_score && signal.checklist_score" class="text-gray-400 text-sm" x-text="signal.checklist_score"></span>
                                <span x-show="!signal.weighted_score && !signal.checklist_score" class="text-gray-500">-</span>
                            </div>
                            <div class="col-span-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-16 bg-gray-600 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all"
                                             :class="signal.confidence >= 70 ? 'bg-green-500' : signal.confidence >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                                             :style="'width: ' + signal.confidence + '%'"></div>
                                    </div>
                                    <span class="text-gray-400 text-xs" x-text="signal.confidence + '%'"></span>
                                </div>
                            </div>
                            <div class="col-span-2 flex items-center justify-between">
                                <span :class="signal.approved ? 'text-green-400' : 'text-red-400'" class="text-sm"
                                      x-text="signal.approved ? 'Approved' : 'Rejected'"></span>
                                <span class="text-gray-500" x-text="signal.expanded ? '▼' : '▶'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <div x-show="signal.expanded"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         class="px-4 pb-4 border-t border-gray-700/50 bg-gray-900/30">

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4">
                            <!-- Checklist Details -->
                            <div x-show="signal.checklist">
                                <h4 class="text-white font-medium mb-3">Checklist Details</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <template x-for="(check, name) in signal.checklist" :key="name">
                                        <div class="flex items-center justify-between p-3 rounded-lg"
                                             :class="check.passed ? 'bg-green-500/10 border border-green-500/20' : 'bg-gray-700/30 border border-gray-600/30'">
                                            <div class="flex items-center gap-3">
                                                <span :class="check.passed ? 'text-green-400 text-lg' : 'text-gray-500 text-lg'"
                                                      x-text="check.passed ? '✓' : '✗'"></span>
                                                <span class="text-white" x-text="formatCheckName(name)"></span>
                                            </div>
                                            <span class="text-gray-400 text-sm" x-text="formatCheckValue(name, check)"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- AI Analysis & Info -->
                            <div>
                                <!-- AI Reasoning -->
                                <div x-show="signal.ai_reasoning" class="mb-4">
                                    <h4 class="text-white font-medium mb-2">AI Analysis</h4>
                                    <p class="text-gray-300 text-sm bg-gray-800 p-3 rounded-lg" x-text="signal.ai_reasoning"></p>
                                </div>

                                <!-- Signal Info -->
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <h4 class="text-white font-medium mb-2">Signal Info</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Price at signal</span>
                                            <span class="text-white" x-text="signal.current_price ? '$' + signal.current_price.toLocaleString() : '-'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">AI Confidence</span>
                                            <span class="text-white" x-text="signal.confidence + '%'"></span>
                                        </div>
                                        <div class="flex justify-between" x-show="signal.weighted_score">
                                            <span class="text-gray-400">Weighted Score</span>
                                            <span class="text-moon-purple font-bold" x-text="signal.weighted_score + '/10'"></span>
                                        </div>
                                        <div class="flex justify-between" x-show="signal.reason">
                                            <span class="text-gray-400">Decision</span>
                                            <span :class="signal.approved ? 'text-green-400' : 'text-red-400'" x-text="signal.reason"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <div x-show="filteredSignals.length === 0" class="py-12 text-center text-gray-500">
                <div class="text-4xl mb-2">&#128269;</div>
                <p>No signals found</p>
            </div>
        </div>
    </div>

    <!-- Load More -->
    <div class="mt-4 text-center" x-show="signals.length >= limit">
        <button @click="loadMore()"
                class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg text-white transition-colors">
            Load More
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function signalsData() {
    return {
        signals: [],
        filter: 'all',
        limit: 50,

        get filteredSignals() {
            if (this.filter === 'all') return this.signals;
            return this.signals.filter(s => s.action === this.filter);
        },

        get avgConfidence() {
            if (this.signals.length === 0) return 0;
            const sum = this.signals.reduce((acc, s) => acc + (s.confidence || 0), 0);
            return Math.round(sum / this.signals.length);
        },

        init() {
            this.fetchSignals();
            // Auto-refresh every 30 seconds (preserve expanded state)
            setInterval(() => this.fetchSignals(), 30000);
        },

        async fetchSignals() {
            try {
                // Preserve expanded state
                const expandedKeys = new Set(
                    this.signals.filter(s => s.expanded).map(s => s.timestamp + s.symbol)
                );

                const data = await apiFetch(`/api/strategy/signals?limit=${this.limit}`);
                this.signals = (data.signals || []).map(s => {
                    const mapped = this.mapSignal(s);
                    mapped.expanded = expandedKeys.has(mapped.timestamp + mapped.symbol);
                    return mapped;
                });
            } catch (e) {
                console.error('Failed to fetch signals:', e);
            }
        },

        mapSignal(s) {
            return {
                timestamp: s.timestamp,
                symbol: s.token || s.symbol,
                action: s.direction || s.action,
                confidence: s.confidence || 0,
                reasoning: s.reason || s.reasoning || '',
                approved: s.approved,
                // Extended fields for Sniper AI
                weighted_score: s.weighted_score,
                checklist_score: s.checklist_score,
                setup_type: s.setup_type,
                ai_reasoning: s.ai_reasoning,
                checklist: s.checklist_details,
                current_price: s.current_price,
                reason: s.reason,
                expanded: false,
            };
        },

        loadMore() {
            this.limit += 50;
            this.fetchSignals();
        },

        formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        formatCheckName(name) {
            const names = {
                'extreme_move': 'Extreme Move',
                'funding_divergence': 'Funding Divergence',
                'liquidation_cascade': 'Liquidation Cascade',
                'multi_tf': 'Multi-Timeframe',
                'volume_climax': 'Volume Climax',
                'time_window': 'Time Window',
                'ai_validation': 'AI Validation',
            };
            return names[name] || name;
        },

        formatCheckValue(name, check) {
            if (!check) return '';
            if (name === 'extreme_move' && check.sigma !== undefined) {
                return `${check.sigma}σ (threshold: ${check.threshold}σ)`;
            }
            if (name === 'funding_divergence' && check.zscore !== undefined) {
                return `Z-score: ${check.zscore}`;
            }
            if (name === 'liquidation_cascade' && check.ratio !== undefined) {
                return `Ratio: ${check.ratio}x`;
            }
            if (name === 'multi_tf' && check.agreement !== undefined) {
                return `Agreement: ${check.agreement}%`;
            }
            if (name === 'volume_climax' && check.ratio !== undefined) {
                return `${check.ratio}x avg`;
            }
            if (name === 'time_window' && check.hour_utc !== undefined) {
                return `${check.hour_utc}:00 UTC`;
            }
            if (name === 'ai_validation' && check.confidence !== undefined) {
                return `${check.confidence}% confidence`;
            }
            return '';
        }
    };
}
</script>
{% endblock %}
